# ðŸ“‹ Compliance Documentation Generator - Multi-Sector Client Workflow
# Copy this file to .github/workflows/compliance-docs.yml in your repository
# Then add required secrets to your repository settings
# Supports: Healthcare (FDA), Financial, Automotive, Aerospace, Industrial
#
# SECURITY FIX: All github.event.inputs are now passed via env blocks
# to prevent command injection (CWE-78). Never use ${{ github.event.inputs.* }}
# directly in run: blocks.

name: ðŸ“‹ Generate Compliance Documentation

on:
  # Manual trigger - for ad-hoc documentation generation
  workflow_dispatch:
    inputs:
      device_name:
        description: 'Your Product/System Name'
        required: true
        default: 'My Product'
      device_manufacturer:
        description: 'Your Company Name'
        required: true
        default: 'My Company'
      device_version:
        description: 'Software Version'
        required: false
        default: '1.0.0'
      output_format:
        description: 'Documentation Scope'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - incremental
      publish_to_confluence:
        description: 'Publish to Confluence'
        required: false
        type: boolean
        default: false
      create_patch_branch:
        description: 'Create patch branch with security fixes (requires contents: write)'
        required: false
        type: boolean
        default: false
      create_pr:
        description: 'Create GitHub PR for patches (requires pull-requests: write)'
        required: false
        type: boolean
        default: false
      base_branch:
        description: 'Base branch for patch branch'
        required: false
        default: 'main'

  # Automatic trigger - on release tags
  push:
    tags:
      - 'v*'
      - 'release-*'
      - '*.*.*'

jobs:
  generate-compliance-docs:
    name: ðŸ“‹ Generate Compliance Documents
    runs-on: ubuntu-latest
    permissions:
      contents: read        # Read-only access (write only needed if create_patch_branch=true)
      issues: read          # Read-only access to issues
      pull-requests: read   # Read-only access (write only needed if create_pr=true)
      security-events: read # Read-only access to security advisories
      # SECURITY NOTE: Set create_patch_branch=false and create_pr=false to minimize permissions
      # If patch generation is disabled, this workflow operates with read-only access

    steps:
    - name: ðŸ“‹ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ§¹ Free Up Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        # This removes ~30GB of disk space to prevent "No space left on device" errors
        tool-cache: true      # Remove preinstalled tools (~14GB)
        android: true         # Remove Android SDK (~11GB)
        dotnet: true          # Remove .NET runtime (~2GB)
        haskell: true         # Remove Haskell (~1GB)
        large-packages: true  # Remove large packages (~4GB)
        docker-images: false  # Keep Docker images (we need them!)
        swap-storage: false   # Keep swap space

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ“¦ Pull Compliance Generator
      env:
        # Use env block for any variable that might be interpolated
        GENERATOR_VERSION: ${{ vars.GENERATOR_VERSION || 'latest' }}
      run: |
        echo "ðŸ“¦ Pulling Compliance Generator container (version: ${GENERATOR_VERSION})..."
        if docker pull lensai/lensai-fda-cybersecurity:${GENERATOR_VERSION}; then
          echo "âœ… Using Compliance Generator version: ${GENERATOR_VERSION}"
          # Tag it as 'latest' locally for consistency
          docker tag lensai/lensai-fda-cybersecurity:${GENERATOR_VERSION} lensai/lensai-fda-cybersecurity:latest
        else
          echo "âš ï¸ Version ${GENERATOR_VERSION} not found, falling back to latest..."
          docker pull lensai/lensai-fda-cybersecurity:latest
        fi

        echo "âœ… Container ready!"

    - name: ðŸ“‹ Generate Compliance Documentation
      env:
        # ============================================================
        # SECTOR CONFIGURATION (NEW!)
        # ============================================================
        SECTOR: ${{ vars.SECTOR || 'healthcare' }}  # healthcare, financial, automotive, aerospace, industrial

        # ============================================================
        # HEALTHCARE-SPECIFIC VARIABLES (Optional)
        # Set as repository variables for enhanced FDA documentation
        # ============================================================
        DEVICE_CLASS: ${{ vars.DEVICE_CLASS || '' }}  # FDA Class: I, II, or III
        INTENDED_USE: ${{ vars.INTENDED_USE || '' }}  # Clinical purpose of device
        PATIENT_POPULATION: ${{ vars.PATIENT_POPULATION || '' }}  # Target patient demographics
        CLINICAL_ENVIRONMENT: ${{ vars.CLINICAL_ENVIRONMENT || '' }}  # Hospital, ICU, home, etc.
        SAMD_CATEGORY: ${{ vars.SAMD_CATEGORY || '' }}  # Software as Medical Device: CLASS_I to CLASS_IV
        HEALTHCARE_SYSTEMS: ${{ vars.HEALTHCARE_SYSTEMS || '' }}  # Integration: HL7,FHIR,DICOM,EHR
        MULTI_PATIENT_CAPABLE: ${{ vars.MULTI_PATIENT_CAPABLE || '' }}  # true/false
        REGULATORY_SUBMISSION_TYPE: ${{ vars.REGULATORY_SUBMISSION_TYPE || '' }}  # 510(k), PMA, De Novo

        # ============================================================
        # CORE CONFIGURATION
        # ============================================================
        LENSAI_API_KEY: ${{ secrets.LENSAI_API_KEY }}
        LENSAI_MODEL: "deepseek-ai/DeepSeek-V3-0324"
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPO: ${{ github.repository }}
        GITHUB_REPO_OWNER: ${{ github.repository_owner }}
        GITHUB_REPO_NAME: ${{ github.event.repository.name }}
        
        # ============================================================
        # USER INPUTS - Passed via env to prevent command injection
        # SECURITY: Never use ${{ github.event.inputs.* }} in run blocks
        # ============================================================
        DEVICE_NAME: ${{ github.event.inputs.device_name }}
        DEVICE_VERSION: ${{ github.event.inputs.device_version }}
        DEVICE_MANUFACTURER: ${{ github.event.inputs.device_manufacturer }}
        OUTPUT_FORMAT: ${{ github.event.inputs.output_format || 'full' }}
        PUBLISH_TO_CONFLUENCE: ${{ github.event.inputs.publish_to_confluence }}
        CREATE_PATCH_BRANCH: ${{ github.event.inputs.create_patch_branch }}
        CREATE_PR: ${{ github.event.inputs.create_pr }}
        BASE_BRANCH: ${{ github.event.inputs.base_branch || 'main' }}

        # ============================================================
        # ATLASSIAN INTEGRATION (OPTIONAL)
        # ============================================================
        JIRA_URL: ${{ secrets.JIRA_URL }}
        JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
        CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
        CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
        CONFLUENCE_SPACE_KEY: ${{ secrets.CONFLUENCE_SPACE_KEY }}

        # ============================================================
        # FEATURE CONFIGURATION
        # ============================================================
        # Confluence Publishing (auto-publishes if credentials configured)
        CONFLUENCE_PUBLISH: ${{ github.event.inputs.publish_to_confluence == 'true' && 'true' || 'auto' }}

        # Patch Generation (automatically generates fixes for vulnerabilities)
        ENABLE_PATCH_GENERATION: "true"

        # JIRA Time Windows
        JIRA_RECENT_DAYS: "90"
        JIRA_SECURITY_DAYS: "180"
        JIRA_DEFAULT_DAYS: "60"

        # Evidence Processing (Batched - no minimums required)
        # The system intelligently handles whatever evidence is available
        FDA_MIN_GITHUB_COMMITS: "0"
        FDA_MIN_SEMGREP_FINDINGS: "0"
        FDA_MIN_JIRA_TICKETS: "0"
        FDA_MIN_CONFLUENCE_PAGES: "0"
        FDA_MIN_SBOM_COMPONENTS: "0"

        # Generation settings
        OUTPUT_DIR: "/output"
        GENERATION_MODE: ${{ github.event.inputs.output_format || 'full' }}

        # Evidence optimization
        FDA_MAX_CODE_EVIDENCE_CHARS: "200000"  # Preserve more code context

      run: |
        echo "ðŸš€ Starting compliance documentation generation..."
        echo "ðŸ“Š Analyzing repository: ${GITHUB_REPO}"
        echo "ðŸ¢ Sector: ${SECTOR}"
        echo "ðŸ“¦ Product: ${DEVICE_NAME} v${DEVICE_VERSION}"

        # Show healthcare-specific configuration if applicable
        if [ "${SECTOR}" = "healthcare" ]; then
          echo "ðŸ¥ Healthcare Configuration:"
          [ -n "${DEVICE_CLASS}" ] && echo "  - FDA Device Class: ${DEVICE_CLASS}"
          [ -n "${INTENDED_USE}" ] && echo "  - Intended Use: ${INTENDED_USE}"
          [ -n "${SAMD_CATEGORY}" ] && echo "  - SaMD Category: ${SAMD_CATEGORY}"
          [ -n "${REGULATORY_SUBMISSION_TYPE}" ] && echo "  - Submission Type: ${REGULATORY_SUBMISSION_TYPE}"
        fi

        # Create output directory
        mkdir -p ./compliance-output

        # Record start time
        START_TIME=$(date +%s)

        # Build patch branch command arguments
        # SECURITY: Using env variables instead of direct interpolation
        PATCH_ARGS=""
        if [ "${CREATE_PATCH_BRANCH}" = "true" ]; then
          PATCH_ARGS="--create-patch-branch"
          if [ "${CREATE_PR}" = "true" ]; then
            PATCH_ARGS="${PATCH_ARGS} --create-pr"
          fi
          PATCH_ARGS="${PATCH_ARGS} --base-branch ${BASE_BRANCH}"
          echo "ðŸ”§ Patch branch options: ${PATCH_ARGS}"
        fi

        # Run compliance documentation generator
        docker run --rm \
          -e SECTOR \
          -e DEVICE_CLASS \
          -e INTENDED_USE \
          -e PATIENT_POPULATION \
          -e CLINICAL_ENVIRONMENT \
          -e SAMD_CATEGORY \
          -e HEALTHCARE_SYSTEMS \
          -e MULTI_PATIENT_CAPABLE \
          -e REGULATORY_SUBMISSION_TYPE \
          -e LENSAI_API_KEY \
          -e LENSAI_MODEL \
          -e GITHUB_TOKEN \
          -e GITHUB_REPO \
          -e GITHUB_REPO_OWNER \
          -e GITHUB_REPO_NAME \
          -e DEVICE_NAME \
          -e DEVICE_VERSION \
          -e DEVICE_MANUFACTURER \
          -e JIRA_URL \
          -e JIRA_EMAIL \
          -e JIRA_API_TOKEN \
          -e JIRA_PROJECT_KEY \
          -e CONFLUENCE_URL \
          -e CONFLUENCE_EMAIL \
          -e CONFLUENCE_API_TOKEN \
          -e CONFLUENCE_SPACE_KEY \
          -e CONFLUENCE_PUBLISH \
          -e ENABLE_PATCH_GENERATION \
          -e JIRA_RECENT_DAYS \
          -e JIRA_SECURITY_DAYS \
          -e JIRA_DEFAULT_DAYS \
          -e FDA_MIN_GITHUB_COMMITS \
          -e FDA_MIN_SEMGREP_FINDINGS \
          -e FDA_MIN_JIRA_TICKETS \
          -e FDA_MIN_CONFLUENCE_PAGES \
          -e FDA_MIN_SBOM_COMPONENTS \
          -e OUTPUT_DIR \
          -e GENERATION_MODE \
          -e OUTPUT_FORMAT \
          -e FDA_MAX_CODE_EVIDENCE_CHARS \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v ${{ github.workspace }}:/repo:ro \
          -v ${{ github.workspace }}/compliance-output:/output \
          lensai/lensai-fda-cybersecurity:latest \
          --mode ${OUTPUT_FORMAT} --output-dir /output ${PATCH_ARGS}

        # Calculate generation time
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))

        # Count generated documents
        DOC_COUNT=$(find ./compliance-output -name "*.md" -type f | wc -l)

        # Calculate success rate
        if [ "${OUTPUT_FORMAT}" = "full" ]; then
          TOTAL_DOCS=11
        else
          TOTAL_DOCS=6  # Essential documents only
        fi
        SUCCESS_RATE=$(( (DOC_COUNT * 100) / TOTAL_DOCS ))

        echo "ðŸ“Š GENERATION RESULTS:"
        echo "   Sector: ${SECTOR}"
        echo "   Documents Generated: ${DOC_COUNT}/${TOTAL_DOCS} (${SUCCESS_RATE}%)"
        echo "   Generation Time: ${DURATION}s"
        echo "   Output Directory: ./compliance-output/"

        echo "ðŸ“„ Generated Compliance Documents:"
        find ./compliance-output -name "*.md" -type f -exec basename {} \; | sort

    - name: ðŸ“Š Upload Compliance Documents
      uses: actions/upload-artifact@v4
      with:
        name: compliance-docs-${{ github.run_id }}
        path: ./compliance-output/
        retention-days: 30
        if-no-files-found: error

    - name: ðŸ“‹ Summary
      env:
        # ============================================================
        # SECURITY FIX: Pass all user inputs via env block
        # This prevents command injection (CWE-78) attacks
        # ============================================================
        SECTOR: ${{ vars.SECTOR || 'healthcare' }}
        DEVICE_NAME: ${{ github.event.inputs.device_name }}
        DEVICE_MANUFACTURER: ${{ github.event.inputs.device_manufacturer }}
        DEVICE_VERSION: ${{ github.event.inputs.device_version }}
        OUTPUT_FORMAT: ${{ github.event.inputs.output_format || 'full' }}
      run: |
        echo "## ðŸ“‹ Compliance Documentation Generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Success!" >> $GITHUB_STEP_SUMMARY
        echo "- **Sector**: ${SECTOR}" >> $GITHUB_STEP_SUMMARY
        echo "- **Product**: ${DEVICE_NAME}" >> $GITHUB_STEP_SUMMARY
        echo "- **Manufacturer**: ${DEVICE_MANUFACTURER}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${DEVICE_VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- **Format**: ${OUTPUT_FORMAT}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“„ Generated Files:" >> $GITHUB_STEP_SUMMARY
        find ./compliance-output -name "*.md" -type f -exec basename {} \; | sort | sed 's/^/- âœ… /' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download the artifacts above to get your compliance documentation!" >> $GITHUB_STEP_SUMMARY

# ============================================================
# CONFIGURATION NOTES
# ============================================================
#
# SECURITY NOTE (CWE-78 - Command Injection Prevention):
# All github.event.inputs values are passed through env: blocks
# and referenced as ${VAR_NAME} in run: blocks. This prevents
# command injection attacks where malicious input could execute
# arbitrary commands. NEVER use ${{ github.event.inputs.* }}
# directly in run: blocks.
#
# SECTOR CONFIGURATION:
# Set the SECTOR repository variable to choose your compliance framework:
# - healthcare: FDA 524B, ISO 14971, IEC 81001-5-1 (default)
# - financial: SOX, MiFID II, PCI-DSS (planned)
# - automotive: ISO 26262, ASIL-D (planned)
# - aerospace: DO-178C, DO-254 (planned)
# - industrial: IEC 62443, NIST CSF (planned)
#
# To set: Go to Settings â†’ Secrets and variables â†’ Actions â†’ Variables
# Add variable: SECTOR = your_sector
#
# HEALTHCARE-SPECIFIC VARIABLES:
# For medical devices, set these repository variables for enhanced documentation:
# - DEVICE_CLASS: FDA device classification (I, II, or III)
# - INTENDED_USE: Clinical purpose and use case
# - PATIENT_POPULATION: Target patient demographics
# - CLINICAL_ENVIRONMENT: Deployment setting (hospital, home, etc.)
# - SAMD_CATEGORY: Software as Medical Device level (CLASS_I to CLASS_IV)
# - HEALTHCARE_SYSTEMS: Integration systems (HL7,FHIR,DICOM,EHR)
# - REGULATORY_SUBMISSION_TYPE: FDA submission type (510(k), PMA, De Novo)
#
# See docs/SECTOR_CONFIGURATION.md for complete configuration guide
#
# ENVIRONMENT VARIABLES:
# The following environment variables can be adjusted based on your needs:
#
# JIRA Time Windows:
# - JIRA_RECENT_DAYS: Days to look back for recent issues (default: 30, example uses 90)
# - JIRA_SECURITY_DAYS: Days to look back for security issues (default: 60, example uses 180)
# - JIRA_DEFAULT_DAYS: Default time window (default: 30, example uses 60)
#
# Evidence Processing:
# The system uses intelligent batched evidence processing that automatically
# compacts and summarizes all available data. No minimum requirements needed.
# Legacy FDA_MIN_* variables are kept at 0 for backward compatibility.
#
# Evidence Optimization:
# - FDA_MAX_CODE_EVIDENCE_CHARS: Maximum characters of code evidence to include (default: 200000)
#
# Confluence Publishing:
# - CONFLUENCE_URL: Your Confluence instance URL (e.g., https://company.atlassian.net/wiki)
# - CONFLUENCE_EMAIL: Your Confluence email address
# - CONFLUENCE_API_TOKEN: Your Confluence API token
# - CONFLUENCE_SPACE_KEY: Target Confluence space key (e.g., FDA)
# - CONFLUENCE_PUBLISH: Enable/disable publishing (auto/true/false)
#
# GITHUB PATCH BRANCHES (NEW!):
# The system can automatically create patch branches with security fixes:
# - create_patch_branch: Creates patch branches (default: true)
# - create_pr: Creates GitHub PRs for patches (default: false)
# - base_branch: Base branch for patches (default: main)
#
# Patch Branch Features:
# - Automatically generates security fixes for detected vulnerabilities
# - Creates descriptive git branches with security patches
# - Can create GitHub PRs with detailed descriptions and confidence levels
# - Supports HIGH/MEDIUM/LOW confidence patches with appropriate review workflows
# - Works with any base branch (main, develop, feature branches)
#
# Required GitHub Permissions:
# - contents: write (for creating branches)
# - pull-requests: write (for creating PRs)
# - This workflow already has the correct permissions configured
#
# Branch Protection:
# The system includes built-in protections for safe operation:
# - Never directly modifies protected branches (main, master, develop, release, production, prod)
# - Always creates new branches from the specified base branch
# - Validates that base branch exists before proceeding
# - Uses descriptive branch names with timestamps to prevent collisions
# - LOW confidence patches create draft PRs requiring manual review
#
# WORKFLOW TRIGGERS:
# This client workflow is designed for:
# 1. Manual execution with version input
# 2. Automatic execution on release tags (v*, release-*, *.*.*)
#
# Version Detection:
# - Release tags: Automatically uses tag name as version
# - Manual runs: Uses device_version input or defaults to 1.0.0
#
# Adjust these values based on your project's maturity and activity level.
# For new projects with limited history, consider using the defaults.
